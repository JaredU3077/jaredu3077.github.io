<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Engineer OS Theme</title>
    <link rel="stylesheet" href="theme.css">
    <!-- Include Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Include vis.js for network topology map -->
    <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
    <!-- Include interact.js for draggable and resizable windows -->
    <script src="https://unpkg.com/interactjs@1.10.27/dist/interact.min.js"></script>
</head>
<body>
    <!-- Start menu and taskbar only, no desktop icons -->
    <div class="taskbar">
        <button class="start-btn" id="startBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12h18M3 6h18M3 18h18"/>
            </svg>
            <span>Start</span>
        </button>
        <div class="start-menu" id="startMenu">
            <!-- Start menu items will be dynamically generated -->
        </div>
        <div class="branding">@JaredU_</div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { ContentParser } from './js/parser.js';
        import { Terminal } from './js/terminal.js';
        import { WindowManager } from './js/window.js';
        import { NetworkVisualization } from './js/network.js';
        import { KeyboardManager } from './js/keyboard.js';
        import { HelpManager } from './js/help.js';
        import { SearchManager } from './js/search.js';
        import { UI_CONFIG, createAppButton } from './js/config.js';

        // Initialize modules
        const windowManager = new WindowManager();
        const helpManager = new HelpManager();
        const searchManager = new SearchManager();
        let network = null;
        let terminal = null;

        // Initialize UI elements
        function initializeUI() {
            const startMenu = document.getElementById('startMenu');
            startMenu.innerHTML = '';

            // Create start menu items for all apps
            Object.values(UI_CONFIG.applications).forEach(app => {
                startMenu.insertAdjacentHTML('beforeend', createAppButton(app, 'start-menu'));
            });

            // Add help button to start menu
            startMenu.insertAdjacentHTML('beforeend', `
                <button class="start-menu-item" title="Help" aria-label="Help" tabindex="0" id="helpBtn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 16v-4M12 8h.01"/>
                    </svg>
                    <span class="label">Help</span>
                </button>
            `);
        }

        // Start menu open/close logic
        const startBtn = document.getElementById('startBtn');
        const startMenu = document.getElementById('startMenu');
        startBtn.setAttribute('aria-haspopup', 'true');
        startBtn.setAttribute('aria-controls', 'startMenu');
        startBtn.setAttribute('tabindex', '0');
        startBtn.setAttribute('role', 'button');
        startBtn.addEventListener('click', () => {
            startMenu.style.display = startMenu.style.display === 'flex' ? 'none' : 'flex';
        });
        startBtn.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                startMenu.style.display = startMenu.style.display === 'flex' ? 'none' : 'flex';
            }
        });
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.start-btn') && !e.target.closest('.start-menu')) {
                startMenu.style.display = 'none';
            }
        });

        // Handle app icon and menu clicks (only in start menu now)
        function handleAppClick(appId) {
            const app = UI_CONFIG.applications[appId];
            if (!app) return;
            app.windows.forEach(windowConfig => {
                const win = windowManager.createWindow({
                    id: windowConfig.id,
                    title: windowConfig.title,
                    content: windowConfig.content,
                    width: windowConfig.width,
                    height: windowConfig.height,
                    icon: app.icon
                });
                switch (appId) {
                    case 'terminal':
                        terminal = new Terminal(
                            win.querySelector('#terminalInput input'),
                            win.querySelector('#terminalOutput')
                        );
                        break;
                    case 'network-monitor':
                        if (windowConfig.id === 'topologyWindow') {
                            network = new NetworkVisualization('networkTopology');
                        }
                        break;
                    case 'codex':
                        if (windowConfig.id === 'codexWindow') {
                            searchManager.initializeSearch();
                        }
                        break;
                    case 'device-manager':
                        // Future: initialize device manager logic here
                        break;
                }
            });
        }

        // Add click handlers for all app buttons (start menu only)
        document.addEventListener('click', (e) => {
            const button = e.target.closest('[data-tool]');
            if (button && button.classList.contains('start-menu-item')) {
                handleAppClick(button.dataset.tool);
                startMenu.style.display = 'none';
            }
            // Help button
            if (e.target.closest('#helpBtn')) {
                helpManager.showHelp();
                startMenu.style.display = 'none';
            }
        });

        // Keyboard accessibility for app buttons
        document.addEventListener('keydown', (e) => {
            if ((e.key === 'Enter' || e.key === ' ') && document.activeElement && document.activeElement.hasAttribute('data-tool') && document.activeElement.classList.contains('start-menu-item')) {
                handleAppClick(document.activeElement.dataset.tool);
                startMenu.style.display = 'none';
            }
            if ((e.key === 'Enter' || e.key === ' ') && document.activeElement && document.activeElement.id === 'helpBtn') {
                helpManager.showHelp();
                startMenu.style.display = 'none';
            }
        });

        // Initialize UI
        initializeUI();
    </script>
</body>
</html>
